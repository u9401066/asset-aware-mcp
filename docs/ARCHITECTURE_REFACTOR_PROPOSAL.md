# ğŸ—ï¸ æ¶æ§‹é‡æ§‹ææ¡ˆï¼šä¸‰å¤§åŠŸèƒ½ç¨ç«‹åŒ–

> **å•é¡Œ**ï¼šåšè¡¨ã€æ‹†è§£æ–‡æœ¬ã€é‡é€è³‡æ–™ä¸‰å€‹åŠŸèƒ½ç›®å‰å­˜åœ¨ä¸å¿…è¦çš„è€¦åˆ
>
> **ç›®æ¨™**ï¼šè®“é€™ä¸‰å€‹åŠŸèƒ½å®Œå…¨ç¨ç«‹ï¼Œäº’ä¸å½±éŸ¿

---

## ğŸ”´ ç•¶å‰å•é¡Œåˆ†æ

### å•é¡Œ 1ï¼šåšè¡¨åŠŸèƒ½è¢«è¿«ä¾è³´ PDF æ‹†è§£

```
ç¾æ³ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User   â”‚ â”€â”€â–º â”‚ ingest_pdf() â”‚ â”€â”€â–º â”‚ create_tableâ”‚
â”‚ æƒ³åšè¡¨  â”‚     â”‚ ï¼ˆè¢«è¿«åŸ·è¡Œï¼‰   â”‚     â”‚  ï¼ˆæ‰èƒ½é–‹å§‹ï¼‰â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å•é¡Œï¼š
- ç”¨æˆ¶å·²ç¶“æœ‰ MD æª”æ¡ˆï¼Œä½†ç„¡æ³•ç›´æ¥ä½¿ç”¨
- TableService åªèƒ½å¾ã€Œå·²æ‹†è§£çš„æ–‡æª”ã€ä¸­æŠ½å–
- æ²’æœ‰ã€Œç›´æ¥è®€å– MD/TXT å…§å®¹ã€çš„å…¥å£
```

### å•é¡Œ 2ï¼šåœ–ç‰‡éœ€è¦é‡è¤‡æ‹†è§£

```
ç¾æ³ï¼š
Session 1: PDF â†’ æ‹†è§£ â†’ images/fig_3_1.png âœ… å·²å­˜åœ¨
Session 2: æƒ³ç”¨ fig_3_1.png â†’ âŒ è¦é‡æ–°æ‹†è§£ PDFï¼Ÿ

å•é¡Œï¼š
- åœ–ç‰‡å·²ç¶“æŒä¹…åŒ–åœ¨ data/doc_XXX/images/
- ä½† AssetService åªèƒ½å¾ã€Œç•¶å‰ session çš„ manifestã€è®€å–
- ç¼ºå°‘ã€Œè³‡ç”¢ç´¢å¼•å±¤ã€ä¾†è¿½è¹¤æ‰€æœ‰å·²å­˜åœ¨çš„è³‡ç”¢
```

### å•é¡Œ 3ï¼šé‡é€è³‡æ–™éœ€è¦å®Œæ•´ä¸Šä¸‹æ–‡

```
ç¾æ³ï¼š
- resume_table() è¿”å›çµæ§‹ + æœ€å¾Œ 2 è¡Œ
- ä½†ç„¡æ³•ã€Œåªé€ç‰¹å®šåœ–ç‰‡ã€æˆ–ã€Œåªé€ç‰¹å®šç« ç¯€ã€
- æ²’æœ‰ã€Œè³‡ç”¢å¿«å–å±¤ã€è®“ Agent æŒ‰éœ€ç²å–
```

---

## ğŸŸ¢ é‡æ§‹æ–¹æ¡ˆï¼šAsset-Centric Architecture

### æ ¸å¿ƒç†å¿µï¼š**è³‡ç”¢å„ªå…ˆï¼Œæµç¨‹è§£è€¦**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Asset Index Layer (NEW)                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚   â”‚  MD Files   â”‚  â”‚   Images    â”‚  â”‚   Tables    â”‚            â”‚
â”‚   â”‚  (å·²å­˜åœ¨)    â”‚  â”‚  (å·²å­˜åœ¨)    â”‚  â”‚  (å·²å­˜åœ¨)    â”‚            â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚          â”‚                â”‚                â”‚                    â”‚
â”‚          â–¼                â–¼                â–¼                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚   â”‚           Asset Registry (NEW)               â”‚             â”‚
â”‚   â”‚  - æƒæ data/ ç›®éŒ„å»ºç«‹ç´¢å¼•                     â”‚             â”‚
â”‚   â”‚  - è¿½è¹¤æ‰€æœ‰å·²å­˜åœ¨çš„è³‡ç”¢                        â”‚             â”‚
â”‚   â”‚  - ä¸éœ€è¦é‡æ–°æ‹†è§£å°±èƒ½ä½¿ç”¨                      â”‚             â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                    â”‚                    â”‚
          â–¼                    â–¼                    â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Table     â”‚    â”‚   ETL       â”‚    â”‚   Asset     â”‚
    â”‚   Service   â”‚    â”‚   Service   â”‚    â”‚   Delivery  â”‚
    â”‚  (åšè¡¨)      â”‚    â”‚  (æ‹†è§£)     â”‚    â”‚   (é‡é€)    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                    â”‚                    â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                         ç¨ç«‹é‹ä½œï¼Œäº’ä¸å¹²æ“¾
```

---

## ğŸ“‹ å…·é«”æ”¹å‹•

### 1. æ–°å¢ Asset Registryï¼ˆè³‡ç”¢è¨»å†Šä¸­å¿ƒï¼‰

```python
# src/domain/asset_registry.py (NEW)

class AssetRegistry:
    """
    æƒæä¸¦ç´¢å¼•æ‰€æœ‰å·²å­˜åœ¨çš„è³‡ç”¢ã€‚
    å•Ÿå‹•æ™‚è‡ªå‹•è¼‰å…¥ï¼Œä¸éœ€è¦é‡æ–°æ‹†è§£ PDFã€‚
    """
    
    def scan_all_assets(self) -> dict[str, Asset]:
        """æƒæ data/ ç›®éŒ„ï¼Œå»ºç«‹è³‡ç”¢ç´¢å¼•"""
        pass
    
    def get_image(self, asset_id: str) -> bytes:
        """ç›´æ¥è®€å–å·²å­˜åœ¨çš„åœ–ç‰‡"""
        pass
    
    def get_markdown(self, doc_id: str) -> str:
        """ç›´æ¥è®€å–å·²å­˜åœ¨çš„ MD æ–‡ä»¶"""
        pass
    
    def list_available_assets(self) -> list[AssetSummary]:
        """åˆ—å‡ºæ‰€æœ‰å¯ç”¨è³‡ç”¢ï¼ˆä¸éœ€è¦é‡æ–°æ‹†è§£ï¼‰"""
        pass
```

### 2. æ”¹é€  TableServiceï¼šæ”¯æ´ç›´æ¥è¼¸å…¥

```python
# src/application/table_service.py (MODIFY)

class TableService:
    def create_table_from_text(
        self,
        text_content: str,  # ç›´æ¥æ¥å—æ–‡å­—å…§å®¹ï¼
        intent: str,
        title: str,
        columns: list[dict],
    ) -> str:
        """
        ç›´æ¥å¾æ–‡å­—å…§å®¹å»ºç«‹è¡¨æ ¼ã€‚
        ä¸éœ€è¦å…ˆæ‹†è§£ PDFï¼
        """
        pass
    
    def create_table_from_files(
        self,
        file_paths: list[str],  # æ¥å—ä»»æ„ MD/TXT æª”æ¡ˆè·¯å¾‘
        ...
    ) -> str:
        """
        å¾ç¾æœ‰çš„ MD æª”æ¡ˆå»ºç«‹è¡¨æ ¼ã€‚
        æ”¯æ´å¤šæª”æ¡ˆåˆä½µå½™æ•´ï¼
        """
        pass
```

### 3. æ–°å¢ MCP Tools

```python
# æ–°å·¥å…· 1: ç›´æ¥ä½¿ç”¨å·²å­˜åœ¨çš„è³‡ç”¢
@mcp.tool()
async def list_available_assets() -> str:
    """
    åˆ—å‡ºæ‰€æœ‰å·²å­˜åœ¨çš„è³‡ç”¢ï¼ˆåœ–ç‰‡ã€MDã€è¡¨æ ¼ï¼‰ã€‚
    ä¸éœ€è¦é‡æ–°æ‹†è§£ PDFï¼
    """
    pass

# æ–°å·¥å…· 2: ç›´æ¥è®€å–åœ–ç‰‡
@mcp.tool()
async def get_existing_image(asset_path: str) -> ImageContent:
    """
    ç›´æ¥è®€å–å·²å­˜åœ¨çš„åœ–ç‰‡æª”æ¡ˆã€‚
    æ”¯æ´çµ•å°è·¯å¾‘æˆ– data/ ç›¸å°è·¯å¾‘ã€‚
    """
    pass

# æ–°å·¥å…· 3: å¾ä»»æ„ MD å»ºè¡¨
@mcp.tool()
async def create_table_from_markdown(
    markdown_paths: list[str],  # ç›´æ¥æŒ‡å®š MD æª”æ¡ˆ
    intent: str,
    title: str,
    columns: list[dict],
) -> str:
    """
    å¾ç¾æœ‰çš„ Markdown æª”æ¡ˆå»ºç«‹è¡¨æ ¼ã€‚
    ä¸éœ€è¦å…ˆæ‹†è§£ PDFï¼æ”¯æ´å¤šæª”æ¡ˆå½™æ•´ã€‚
    """
    pass

# æ–°å·¥å…· 4: ç›´æ¥è¼¸å…¥æ–‡å­—åšè¡¨
@mcp.tool()
async def create_table_from_text(
    text_content: str,  # ç›´æ¥è²¼ä¸Šæ–‡å­—å…§å®¹
    intent: str,
    title: str,
    columns: list[dict],
) -> str:
    """
    ç›´æ¥å¾æ–‡å­—å…§å®¹å»ºç«‹è¡¨æ ¼ã€‚
    é©åˆå¾èŠå¤©ä¸­è²¼ä¸Šå…§å®¹ç›´æ¥åšè¡¨ã€‚
    """
    pass
```

---

## ğŸ”„ æ–°å·¥ä½œæµç¨‹

### åšè¡¨æµç¨‹ï¼ˆç¨ç«‹ï¼‰

```
æ–¹å¼ A: å¾å·²æ‹†è§£çš„æ–‡æª”
list_documents() â†’ get_section_content() â†’ add_rows()

æ–¹å¼ B: å¾ç¾æœ‰ MD æª”æ¡ˆ (NEW!)
list_available_assets() â†’ create_table_from_markdown([paths])

æ–¹å¼ C: ç›´æ¥è¼¸å…¥æ–‡å­— (NEW!)
create_table_from_text(text_content, ...)
```

### æ‹†è§£æµç¨‹ï¼ˆç¨ç«‹ï¼‰

```
ingest_documents([pdf_paths])
  â†’ éåŒæ­¥ Job
  â†’ ç”¢ç”Ÿ manifest + images + markdown
  â†’ è‡ªå‹•è¨»å†Šåˆ° Asset Registry
```

### é‡é€è³‡æ–™æµç¨‹ï¼ˆç¨ç«‹ï¼‰

```
æ–¹å¼ A: é€è¡¨æ ¼
resume_table(table_id) â†’ çµæ§‹ + æœ€å¾Œ 2 è¡Œ

æ–¹å¼ B: é€åœ–ç‰‡ (NEW!)
get_existing_image("data/doc_XXX/images/fig_3_1.png")

æ–¹å¼ C: é€ç« ç¯€
get_section_content(doc_id, section_id)

æ–¹å¼ D: é€å¤šè³‡ç”¢çµ„åˆ (NEW!)
get_asset_bundle([
    {"type": "image", "path": "..."},
    {"type": "section", "id": "..."},
    {"type": "table", "id": "..."},
])
```

---

## ğŸ“Š æ”¹å‹•ç¯„åœ

| å±¤ç´š | æª”æ¡ˆ | æ”¹å‹• |
|------|------|------|
| **Domain** | `asset_registry.py` (NEW) | è³‡ç”¢ç´¢å¼•æ ¸å¿ƒé‚è¼¯ |
| **Domain** | `entities.py` | æ–°å¢ `AssetSummary` å¯¦é«” |
| **Application** | `table_service.py` | æ–°å¢ `create_table_from_*` æ–¹æ³• |
| **Application** | `asset_service.py` | æ•´åˆ AssetRegistry |
| **Infrastructure** | `file_storage.py` | æ–°å¢è³‡ç”¢æƒæåŠŸèƒ½ |
| **Presentation** | `server.py` | æ–°å¢ 4 å€‹ MCP Tools |

---

## â±ï¸ å¯¦æ–½é †åº

### Phase 1: Asset Registryï¼ˆæ ¸å¿ƒï¼‰
1. å»ºç«‹ `AssetRegistry` é¡åˆ¥
2. å¯¦ä½œè³‡ç”¢æƒæåŠŸèƒ½
3. å•Ÿå‹•æ™‚è‡ªå‹•è¼‰å…¥ç´¢å¼•

### Phase 2: Table Service æ“´å±•
1. æ–°å¢ `create_table_from_text()`
2. æ–°å¢ `create_table_from_files()`
3. æ›´æ–°æ¸¬è©¦

### Phase 3: MCP Tools
1. æ–°å¢ `list_available_assets`
2. æ–°å¢ `get_existing_image`
3. æ–°å¢ `create_table_from_markdown`
4. æ–°å¢ `create_table_from_text`

### Phase 4: Asset Bundleï¼ˆé€²éšï¼‰
1. å¯¦ä½œ `get_asset_bundle` æ‰¹æ¬¡ç²å–
2. å„ªåŒ– Token æ¶ˆè€—

---

## âœ… é æœŸæˆæœ

| åŠŸèƒ½ | ç¾ç‹€ | é‡æ§‹å¾Œ |
|------|------|--------|
| **åšè¡¨** | å¿…é ˆå…ˆæ‹†è§£ PDF | å¯ç›´æ¥å¾ MD/TXT å»ºè¡¨ |
| **ç”¨åœ–** | æ¯æ¬¡é‡æ–°æ‹†è§£ | ç›´æ¥è®€å–å·²å­˜åœ¨åœ–ç‰‡ |
| **å½™æ•´** | åªèƒ½å–®æ–‡æª” | æ”¯æ´å¤š MD æª”æ¡ˆåˆä½µ |
| **é‡é€** | éœ€è¦å®Œæ•´æµç¨‹ | æŒ‰éœ€ç²å–ä»»æ„è³‡ç”¢ |

---

*ææ¡ˆæ—¥æœŸ: 2026-01-12*
*ç‹€æ…‹: å¾…è¨è«–*
